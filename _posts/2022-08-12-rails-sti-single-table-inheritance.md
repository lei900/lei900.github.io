---
title: 単一テーブル継承(STI)について
category: "Ruby on Rails"
tags: [Ruby on Rails, Database]
---

応用篇でのtaxonomiesテーブルは何なんだって気になってて、調べてみたら、単一テーブル継承(STI)で使ってるテーブルのことがわかった。

同じ親クラスから継承している複数の子モデルの情報は各自のテーブルではなく、全てを親モデルのテーブルに記入する。  
各子モデルの情報はtypeコラムで標識する。

今回はauthor, category, tagの三つのモデルの情報をtaxonomiesテーブルに記入している  
どのモデルの情報かを標識するため、モデル名をtypeコラムに記入する。  
それで、三つのテーブルそれぞれ作成するのが不要になる。  

本当はDBには一つの集約テーブルしか存在しないけど、  
レコードを取得するとき、それぞれのテーブルが存在するかのように扱える  
例えば、authorのレコードを全部取得するなら、普通に`Author.all`でいける。  
実際に発行するSQL文は`SELECT "taxonomies".* FROM "taxonomies" WHERE "taxonomies"."type" IN ('Author')`  

ただ現場ではSTIはあまり活用されていないようで、qiitaで向き不向きの議論があった  
- 単純にtypeフィールドが文字列で入るので空間効率が良くない。とくにレコード件数が数億件を超えるような時系列テーブルになると、この反復は無視できない
- STIとして実装したサブクラスには独自メソッドが1個か2個しかないようなケースも多く、ほとんどが共通の処理で、このような場合にはサブクラスの定義ファイルが分割されてしまうのはかえって見通しを悪くしてしまい
- 多段継承がない場合、enumで処理の異なる部分だけを分岐してやったほうが、全体としてコピペも減り、フローも追いやすくなる
- サードパーティのgemがSTIでの利用を考慮していないため、実装上うまくいかなくて、そのgemの利用が無理になったケースが多い


参照
[シングルテーブル継承 （STI）](https://railsguides.jp/association_basics.html#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E7%B6%99%E6%89%BF-%EF%BC%88sti%EF%BC%89)
[クラスの継承（単一テーブル継承）](https://ryota21silva.hatenablog.com/entry/2020/06/09/184330)
[みんなRailsのSTIを誤解してないか!?](https://qiita.com/yebihara/items/9ecb838893ad99be0561)