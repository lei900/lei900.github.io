---
title: Readable Codeメモ：コメントの書き方
category: "Software Design"
tags: ["Better Code", Refactor, "Reading Notes"]
---

**読みやすさの基本定理とは**

>コードは他の人が最短時間で理解できるように書かなければいけない。

## 第6章：コメントすべきところ

### 1. コメントするべきでは「ない」こと

**考え方：** コードからすぐにわかることをコメントに書かない  
=> **コメントは新しい価値を提供する**

悪い例1：
```python
# 2番目の'*'以降を全て削除する
name = '*'.join(line.split('*')[:2]
```

**ひどい名前は、コメントをつけずに名前自体を変更すべき**

変数名を自己文書化にするべき

悪い例2：
```c++
// Replyに対してRequestで記述した制限を課す
// 例えば、返ってくる項目すうや合計バイト数など
void CleanReply(Request request, Reply reply);
```
制限を課すなら、enforce limit使った方良い
```c++
// 'reply'を'request'にある項目数やバイト数の制限に合わせる
void EnforceLimitsFromRequest(Request request, Reply reply);
```

悪い例3：
```c++
// レジストリキーのハンドルを解放する。実際のレジストリは変更しない
void DeleteRegistry(RegistryKey* key);
```
`DeleteRegistry`は危険な関数のように見えるが、コメントには「実際は変更しない」と書いている。

```c++
void ReleaseRegistryHandle(RegistryKey* key);
```

### 2. 自分の考えを記録する

**なぜコードが他のやり方ではなく、こうなっているのか、大切な考え方を書く**

良い例
```c++
// このデータだとハッシュテーブルよりもバイナリツリーの方が40%速かった
// 左右の比較よりもハッシュの計算コストの方が高いようだ
```

**コードが汚い理由を書く**

良い例
```c++
// このクラスは汚くなってきている。
// サブクラス'ResourceNode'を作って整理した方がいいかもしれない
```

- よく使う記法
  - TODO：　あとで手をつける (todo: 小さな問題
  - FIXME: 既知の不具合があるコード
  - HACK: あまり綺麗じゃない解決策
  - XXX: 危険！大きな問題がある

**定数の値にまつわる「背景」をコメントで説明**

良い例:
```python
NUM_THREADS = 8  # 値は「>= 2 * num_processors」で十分

# 合理的な限界値。人間はこんなに読めない。
const int MAX_RSS_SUBSCRIPTIONS = 1000

# 0.72ならユーザーはファイルサイズと品質の面で妥協できる
image_quality = 0.72
```

### 3. 読み手の立場になって考える

**コードを読んだ人が「えっ?」と思うところを予想してコメントをつける**

悪い例：
```c++
void Clear() {
	vector<float>.swap(data); //　えっ？　どうしてdata.clear()じゃないの?
```
 => `ベクタのメモリを解放する`　のコメントを追加するべき

**ハマりそうな罠を告知する**

「このコードを見てびっくりすることはなんだろう？  
どんなふうに間違えて使う可能性があるだろう？」と自分に問いかける。

良い例：
```c++
// メールを送信する外部サービスを呼び出している（1分でタイムアウト）
void SendEmail(string to, string subject, string body);

// 実行時間は0(タグの数 * タグの深さの平均)なので、ネストの深さに気をつける
def FixBrokenHtml(html):...
```

**ファイルやクラスに「全体像」のコメントを書く**

良い例：
```c++
// このファイルには、ファイルシステムに関する便利なインタフェースを提供
// するヘルパー関数が含まれています。ファイルのパーミッションなどを扱います
```

**読み手が細部に捕らわれないように、コードブロックにコメントをつけて概要をまとめる**

良い例：
```python
# 顧客が自分で購入した商品を検索する
for customer_id in all_customers:
	for salse in all_sales[customer_id].sales:
		if sale.recipient == customer_id:
     ...

def GenerateUserReport():
	# このユーザーのロックを獲得する

  # ユーザーの情報をDBから読み込む

  # 情報をファイルに書き出す

  # このユーザーのロックを解放する
```

**コメントを書く作業を三つの手順に分解する**
- 頭の中にあるコメントをとにかく書き出す
- コメントを読んで、改善が必要なものを見つける
- 改善する

## 第6章：コメントは正確で簡潔に

**複数のものを指す可能性がある「それ」や「これ」などの代名詞を避ける**

悪い例：  
「それ」が不明確
```c++
// データをキャッシュに入れる。ただし、先にそのサイズをチェックする
```
改善後：
```c++
// データをキャッシュに入れる。ただし、先にデータのサイズをチェックする
```

或いは、それを明確するように書き直す
```c++
// データーが十分に小さければ、それをキャッシュに入れる。
```

**歯切れの悪い文章を磨く**

悪い例：
```c++
// これまでにクロールしたURLかどうかによって優先度を変える
```
意味をもっと直接で明確にするべき  
改善後：
```c++
// これまでにクロールしていないURLの優先度を高くする
```

**関数の動作はできるだけ正確に説明する**

悪い例：  
行の定義が曖昧なので、理解が異なる。
```c++
// このファイルに含まれる行数を返す
```
改善後
```c++
// このファイルに含まれる改行文字('\n')を数える
```

**コメントに含める入出力の実例を慎重に選ぶ**

改善前：
```c++
// 'scr'の先頭や末尾にある'chars'を除去する
```
改善後：実例を追加
```c++
// 実例： Strip("abba/a/ba", "ab")は"/a/"を返す
```

**コードの意図は、詳細レベルではなく、高いレベルで記述する**

改善前：
```c++
// listを逆順にイテレートする
```
改善後：
```c++
// 値段の高い順に表示する
```

**よくわからない引数にはインラインコメントを使う**

C++やJavaのような言語は、名前付き引数の形式が使えないけど、インラインコメントを使うと、同じ効果がある。

名前付き引数を使う：
```python
connect(timeout_ms = 10, user_encryption = false)
```
インラインコメントを使う：
```c++
Connect(/* timeout_ms = */ 10, /* user_encryption = */ false);
```

**情報密度の高い言葉や表現を使って、コメントを簡潔に保つ**

パターンやイディオムを説明するための専門用語を使う

良い例：  
キャッシュ層や正規化という用語を使用することで、より簡潔で説明できる

```c++
// このクラスの役割は、データベースのキャッシュ層である。

// 所在地を正規化する(例："Avenue" -> "Ave.")
```

---
参照  
[リーダブルコード ―より良いコードを書くためのシンプルで実践的なテクニック](https://www.oreilly.co.jp/books/9784873115658/)
